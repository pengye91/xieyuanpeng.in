<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>
   Made with Remarkable!
  </title>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css" rel="stylesheet"/>
  <style type="text/css">
   h1,h2,h3,h4{color:#6495ed}body,table tr{background-color:#fff}table tr td,table tr th{border:1px solid #ccc;text-align:left;padding:6px 13px;margin:0}pre code,table,table tr{padding:0}body{font-family:Helvetica,Arial,sans-serif}h1,h2{text-align:center}blockquote{background:#f9f9f9;border-left:10px solid #6495ed;margin:1.5em 10px;padding:.5em 10px;font-style:italic}blockquote p{display:inline}hr{clear:both;float:none;width:100%;height:2.5px;margin:1.4em 0;border:none;background:#ddd;background:-webkit-gradient(linear,left bottom,right bottom,color-stop(0,#fff),color-stop(.1,#ddd),color-stop(.9,#ddd),color-stop(1,#fff)) #ddd;background:-moz-linear-gradient(left center,#fff 0,#ddd 10%,#ddd 90%,#fff 100%) #ddd}table tr{border-top:1px solid #ccc;margin:0}table tr:nth-child(2n){background-color:#aaa}table tr th{font-weight:700}table tr td :first-child,table tr th :first-child{margin-top:0}table tr td:last-child,table tr th :last-child{margin-bottom:0}code,tt{margin:0 2px;padding:0 5px;white-space:nowrap;border:1px solid #eaeaea;background-color:#f8f8f8;border-radius:3px}pre code{margin:0;white-space:pre;border:none;background:0 0}.highlight pre,pre{background-color:#f8f8f8;border:1px solid #ccc;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px;border-radius:3px}
  </style>
 </head>
 <body>
  <h1 id="python-3">
   Python 函数式编程学习3
  </h1>
  <h3 id="nonlocal">
   nonlocal变量
  </h3>
  <p>
   考虑如下的函数：
  </p>
  <pre><code class="python">In [14]: def make_averager():
    ...:     count = 0
    ...:     total = 0
    ...:     
    ...:     def averager(new_value):
    ...:         count += 1
    ...:         total += new_value
    ...:         return total / count
    ...:     
    ...:     return averager
    ...: 

In [15]: avg = make_averager()

In [16]: avg(10)
---------------------------------------------------------------------------
UnboundLocalError                         Traceback (most recent call last)
&lt;ipython-input-16-2b3d43cb065d&gt; in &lt;module&gt;()
----&gt; 1 avg(10)

&lt;ipython-input-14-fe9bdbf03cae&gt; in averager(new_value)
      4 
      5     def averager(new_value):
----&gt; 6         count += 1
      7         total += new_value
      8         return total / count

UnboundLocalError: local variable 'count' referenced before assignment

</code></pre>
  <p>
   函数定义的问题在于：
   <code>
    count += 1
   </code>
   对自由变量赋值了，
   <code>
    total
   </code>
   也是同样的问题。
  </p>
  <p>
   但是上一节中的实例函数中：
   <code>
    series.append(new_value）
   </code>
   就没有这个问题，这是因为
   <strong>
    series是可变类型list
   </strong>
   。但是对于不可变类型来说，自由变量只能读取，不能更新，如果尝试重新绑定，如
   <code>
    count = count + 1
   </code>
   ，会隐式创建局部变量
   <code>
    count
   </code>
   ，这样一来，
   <code>
    count
   </code>
   就不是自由变量了，因此不会保存在闭包中。
  </p>
  <p>
   <strong>
    解决: nonlocal声明
   </strong>
  </p>
  <p>
   <code>
    nonlocal
   </code>
   关键字的作用是把变量标记为自由变量。
  </p>
  <p>
   如果nonlocal声明的变量被赋予新值，闭包中保存的绑定会更新。
  </p>
  <p>
   正确的代码如下：
  </p>
  <pre><code class="python">In [17]: def make_averager():
    ...:     count = 0
    ...:     total = 0
    ...:     
    ...:     def averager(new_value):
    ...:         nonlocal count, total
    ...:         count += 1
    ...:         total += new_value
    ...:         return total / count
    ...:     
    ...:     return averager
    ...: 
    ...: 

In [18]: avg = make_averager()

In [19]: avg(10)
Out[19]: 10.0

In [20]: avg(20)
Out[20]: 15.0

In [21]: avg(200)
Out[21]: 76.66666666666667
</code></pre>
  <p>
   <em>
    注意：nonlocal只在python3中可用,
    <a href="http://www.python.org/dev/peps/pep-3104/">
     python2需要用hack的方法
    </a>
   </em>
  </p>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>